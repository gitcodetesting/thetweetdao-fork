<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TweetDAO - Fork</title>
</head>
<body style="width: 100%; max-width: 480px; margin: 0 auto;">
    <div style="display: inline-block; width: 100%;">
        <span style="float: left; font-weight: bold; padding: 16px; padding-left: 0px;">TweetDAO</span>
        <a id="connect" style="float: right; font-weight: bold; background-color: #1FB712; color: white; padding: 16px; border-radius: 100px; text-decoration: none;" href="#">Connect Button</a>
    </div>
    <div style="display: flex; align-items: flex-start; justify-content: space-between; width: 100%; margin-top: 24px;"">
        <img src="image/pfp.png" />
        <textarea id="tweettext" style="margin: 0px; border-radius: 10px; font-size: 16px; border-color: #CFCFCF; width: 80%; height: 100px; font-family: Avenir; padding: 10px"
        placeholder="Tweet from @TheTweetDAO..."></textarea>
    </div>
    <div style="display: inline-block; width: 100%; margin-top: 20px;">
        <span id="balance" style="color: #777">You have 0 eggs</span>
        <a id="tweet" style="float: right; font-weight: bold; background-color: #24BCEC; color: white; padding: 16px; border-radius: 100px; text-decoration: none;" href="#">Tweet</a>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: center; width: 100%; margin-top: 20px; margin-bottom: 20px; text-align: center;">
        <p style="font-weight:bold">The Minting Period is Over! Get a Tweet DAO Egg NFT on OpenSea</p>
        <a href="https://opensea.io/collection/tweet-dao-eggs"><img style="width: 50%" src="image/opensea.png" /></a>
    </div>
    <a class="twitter-timeline" href="https://twitter.com/TheTweetDao?ref_src=twsrc%5Etfw">Tweets by TheTweetDao</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">
        import { ethers } from './ethers.min.js';
        import contractAbi from './contract-abi.json' assert { type: "json" };

        let signer = null;
        let contract = null;
        let supply = 0;

        const connect = async () => {
            const provider = new ethers.providers.Web3Provider(window.ethereum, 'any');

            await provider.send('eth_requestAccounts', []);

            signer = provider.getSigner();
            contract = new ethers.Contract('0x0Db9e2f4395a179e4ADd26B43cFe8E4Ea1830B46', contractAbi, signer);
            supply = await contract.totalSupply();

            $('#balance').text('You have ' + await contract.balanceOf(await signer.getAddress()) + ' eggs');
            $('#price').text('Current Price: ' + (await contract.getPrice())/10**18 + ' ETH');
            $('#supply').text('Minted Supply: ' + supply + '/1000');
            $('#connect').text((await signer.getAddress()).substr(0, 6) + '...');
        };

        $('#connect').click(function (event) {
            event.preventDefault();

            connect();
        });

        $('#tweet').click(async function (event) {
            event.preventDefault();

            if (signer) {
                const timestamp = Date.now();
                const text = $('textarea').val();
                const signature = await signer.signMessage('TweetDao: ' + timestamp.toString() + ' ' + text);

                $.ajax('/.netlify/functions/tweet', {
                    data: JSON.stringify({
                        timestamp,
                        text,
                        signature,
                    }),
                    contentType : 'application/json',
                    type : 'POST',
                }).then(r => alert(r.message));
            } else {
                alert('Connect wallet first');
            }
        });
    </script>
</body>
</html>
